<!DOCTYPE html>
<html>
<head >
    <title>数据字典</title>
    <meta charset="utf-8">
    <link href="../css/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="../js/ztree/zTreeStyle.css"  rel="stylesheet" type="text/css" />
    <style type="text/css">
        .tree {padding:20px 0 0 0;}
        #ztree { width: 300px; overflow-y: auto; }
        #ztree * { font-size: 13px; }
        #labid { font-size: 14px; }
    </style>
</head>
<body>
<div class="container">
    <div class="row">
        <div class="col-sm-3">
            <div class="btn-group " role="group">
                <button type="button" id="btnAddNode" class="btn btn-default">添加</button>
                <button type="button" id="btnDel" class="btn btn-default">删除</button>
                <button type="button" id="btnMoveUp" class="btn btn-default">上移</button>
                <button type="button" id="btnMoveDown" class="btn btn-default">下移</button>
            </div>
            <div class="tree">
                <ul id="ztree" class="ztree"></ul>
            </div>
        </div>
        <div class="col-sm-6" style="padding:50px 0 0 0;">
            <form class="form form-horizontal" role="form">
                <div class="form-group">
                    <label  class="col-sm-3 control-label">字典编码</label>
                    <div class="col-sm-9" style=" padding:5px 0 0 0;">
                        <span id="spandicid"  style="padding:0 0 0 10px; display:inline-block;"></span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="txtname" class="col-sm-3 control-label">字典名称</label>
                    <div class="col-sm-9">
                        <input type="text" class="form-control" name="txtname" id="txtname" />
                        <input type="hidden" id="txtdicid" name="txtdicid" />
                        <input type="hidden" id="txtparentid" name="txtparentid" value="0" />
                        <input type="hidden" id="txtAction" name="txtAction" value="add" />
                    </div>
                </div>
                <div class="form-group">
                    <label for="txtcode" class="col-sm-3 control-label">标准值</label>
                    <div class="col-sm-9">
                        <input type="text" class="form-control" name="txtcode" id="txtcode" />
                    </div>
                </div>
                <div class="form-group">
                    <label for="txtName" class="col-sm-3 control-label">显示状态</label>
                    <div class="col-sm-9">
                        <label class="radio-inline">
                            <input type="radio" id="txtdisplay1" name="txtdisplay" value="1" />显示
                        </label>
                        <label class="radio-inline">
                            <input type="radio" id="txtdisplay0" name="txtdisplay" value="0" />隐藏
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="txtmemo" class="col-sm-3 control-label">备注</label>
                    <div class="col-sm-9">
                        <input type="text" class="form-control" name="txtmemo" id="txtmemo" />
                    </div>
                </div>
                <div class="form-group">
                    <div class="col-sm-offset-3 col-sm-9">
                        <button type="button" id="btnSubmit" class="btn btn-primary">提交</button>
                    </div>
                </div>
            </form>
        </div>

    </div>
</div>

<script src="../js/jquery-1.11.3.min.js" type="text/javascript"></script>
<script src="../js/bootstrap.min.js" type="text/javascript"></script>

<script src="../js/ztree/jquery.ztree-2.6.min.js" type="text/javascript"></script>
<script type="text/javascript" th:inline="javascript">
    var IsRoot=function(){
        if($("#txtdicid").val()==""){
            alert("请选择字典节点！");
            return true;
        }else{
            return false;
        }
    }
    $("#btnAddNode").click(function(){
        var pid=$("#txtdicid").val();
        $(".form").find("input:not([type=radio]),select").val("");
        if(pid==""){
            pid="0";
        }
        $("#txtparentid").val(pid);
        $("#txtAction").val("add");
        $("#txtdisplay1")[0].checked=true
        $("#spandicid").html("");
        return false;
    });
    $("#btnDel").click(function(){
        if(confirm("删除该字典可能会引发错误，确定删除？")){
            if(!IsRoot()){
                $("#txtAction").val("delete");
                return sumbitform(resultFunction);
            }
        }
    });
    $("#btnMoveUp").click(function(){
        if(!IsRoot()){
            $("#txtAction").val("up");
            sumbitform(resultFunction);
            $("#txtAction").val("modify");
        }
    });
    $("#btnMoveDown").click(function(){
        if(!IsRoot()){
            $("#txtAction").val("down");
            sumbitform(resultFunction);
            $("#txtAction").val("modify");
        }
    });
    $("#btnSubmit").click(function(){
        if($("#txtname").val()==""){
            alert("请输入字典名称");
            return false;
        }
        sumbitform(resultFunction);
        return false;
    });
    var zTreeOnClick=function(event,treeID,treeNode){
        $("#spandicid").html(treeNode.id);
        $("#txtdicid").val(treeNode.id);
        $("#txtname").val(treeNode.name);
        $("#txtparentid").val(treeNode.pid);
        $("#txtdisplay"+treeNode.display)[0].checked=true;
        $("#txtcode").val(treeNode.code);
        $("#txtmemo").val(treeNode.memo);
        if($("#txtdicid").val()==""){
            $("#txtAction").val("add");
        }else{
            $("#txtAction").val("modify");
        }
    }
    function getPreTreeNode(treeNode) {
        if (treeNode.isFirstNode) return null;
        var nodes = treeNode.parentNode ? treeNode.parentNode.nodes : zTreeObj.getNodes();
        var preNode;
        for (var i=0; i<nodes.length; i++) {
            if (nodes[i] == treeNode) {
                return preNode;
            }
            preNode = nodes[i];
        }
    }
    function getNextTreeNode(treeNode) {
        if (treeNode.isLastNode) return null;
        var nodes = treeNode.parentNode ? treeNode.parentNode.nodes : zTreeObj.getNodes();
        for (var i=0; i<nodes.length; i++) {
            if (nodes[i] == treeNode) {
                return nodes[i+1];
            }
        }
    }
    var treedate=[[${dics}]];
    treedate.push({id:0,pid:-1,name:"数据字典",open:true,display:1});
    var setting={
        showLine:true,
        expandSpeed:"",
        isSimpleData: true,
        rootPID: "-1",
        treeNodeKey:"id",
        treeNodeParentKey:"pid",
        callback:{
            click:zTreeOnClick
        }
    }
    var zTreeObj=$('#ztree').zTree(setting, treedate);


    var resultFunction=function(id){
        var node=zTreeObj.getSelectedNode();
        switch($("#txtAction").val()){
            case "add":
                node={};
                node.id=id;
                node.pid=$("#txtparentid").val();
                node.name=$("#txtname").val();
                node.display=$("[name=txtdisplay]:checked").val();
                node.memo=$("#txtmemo").val();
                node.code=$("#txtcode").val();
                node.open=true;
                var parentnode=zTreeObj.getSelectedNode();
                if(node.id!=undefined&&node.id!=""){
                    zTreeObj.addNodes(parentnode?parentnode:null, node);
                }
                if(zTreeObj.getSelectedNode()!=null){
                    zTreeOnClick(null,"ztree",zTreeObj.getSelectedNode());
                }
                break;
            case "delete":
                var delnode=node;
                zTreeObj.removeNode(delnode);
                break;
            case "modify":
                node.pid=$("#txtparentid").val();
                node.name=$("#txtname").val();
                node.display=$("[name=txtdisplay]:checked").val();
                node.memo=$("#txtmemo").val();
                node.code=$("#txtcode").val();
                zTreeObj.updateNode(node,true);
                break;
            case "up":
                var targetnode=node;
                if(targetnode.isFirstNode){
                    msg = "已经是第一个节点了！";
                }else{
                    var parent=getPreTreeNode(targetnode);
                    if(parent!=null){
                        zTreeObj.moveNode(parent,targetnode,"before");
                    }
                }
                break;
            case "down":
                var downnode=node;
                if(downnode.isLastNode){
                    msg = "已经是最后一个节点了！";
                }else{
                    var downparent=getNextTreeNode(downnode);
                    if(downparent!=null){
                        zTreeObj.moveNode(downparent,downnode,"after");
                    }
                }
                break;
        }
    }
    var sumbitform=function(callback){
        console.info($(".form").serialize());
        $.ajax({
            type: "POST",
            url:location.href,
            data: $(".form").serialize(),
            dataType: "json",
            async: false,
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                alert("数据保存错误。");
            },
            success: function (data) {
                $("#btnSubmit").removeAttr("disabled");
                msg = "保存成功";
                if(data){
                    callback(data);
                    $("#message").html(msg).show().fadeOut(2000);
                }
            },
            beforeSend: function () {
                $("#btnSubmit").attr("disabled","disabled");
            },
            complete: function () {
                $("#btnSubmit").removeAttr("disabled");
            }
        });
        return false;
    }
</script>
</body>
</html>
