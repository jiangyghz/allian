<!DOCTYPE html>
<html lang="ZH-CN" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>
        角色设置
    </title>
    <link href="../css/css.css" rel="stylesheet" type="text/css">
    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../js/ztree/zTreeStyle.css" rel="stylesheet" type="text/css">
    <script type="text/javascript" src="../js/jquery-1.8.3.min.js"></script>
    <script type="text/javascript" src="../js/json2.js"></script>
    <script type="text/javascript" src="../js/jquery-ui.min.js"></script>
    <script src="../js/ztree/jquery.ztree-2.6.min.js" type="text/javascript"></script>
    <script src="../js/jQuery.tmpl.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="../js/common.js"></script>
    <script src="../js/jquery.cookie.js"></script>
    <style type="text/css">
        .ui-widget-overlay {
            opacity: 0.5;
        }

        .ui-button .ui-icon {
            background-image: url(../images/icon2.png);
            background-position: -154px -104px;
        }

        .ui-button .ui-icon:hover {
            background-image: url(../images/icon2.png);
            background-position: -154px -104px;
        }

        .ztree {
            padding: 0;
        }

        .panel h1 {
            font-size: 20px;
            height: 30px;
        }

        #ztree {
            width: 300px;
            overflow-y: auto;
            height: 100%;
        }

        #ztree * {
            font-size: 13px;
        }

        #treemenu {
            width: 300px;
            overflow-y: auto;
            height: 100%;
        }

        #treemenu * {
            font-size: 13px;
        }

        .divBtn1 {
            margin: 0px;
            padding: 0px;
            height: 12px;
            cursor: pointer;
            border: 0px;
        }

        #extendMenuBox span {
            overflow: visible;
        }

        #extendMenuBox div {
            overflow: visible;
            display: inline;
        }

        .lbl {
            width: 100px;
            display: inline;
        }

        .ipt {
            width: 200px;
            display: inline;
        }

        .roleItem {
            border: 1px dashed #ccc;
            height: 20px;
            vertical-align: middle;
            line-height: 20px;
            cursor: move;
            margin: 0px 0 5px 0;
        }

        .actionItem {
            border: 1px dashed #ccc;
            min-height: 80px;
            width: 360px;
            line-height: 22px;
        }

        .actionItem span {
            display: inline-block;
            margin: 0 3px;
            border: 1px dashed #ccc;
            cursor: pointer;
            background: url(../images/close2.gif) no-repeat right 50%;
            padding-right: 8px;
        }
    </style>
</head>

<body>
    <div class="panel table-responsive" style="margin:0;">
        <table class="table table-striped table-bordered cbg" style="margin:0;">
            <!-- <div class="bd">

            <table width="100%" border="0" align="center" cellpadding="0" cellspacing="1" bgcolor="#d8d8d8" class="cbg"> -->
            <tbody>
                <tr>
                    <td align="right" valign="middle" bgcolor="#FFFFFF">角色名称：</td>

                    <td align="left" valign="middle" bgcolor="#FFFFFF">
                        <select id="act" name="act" style="width:140px;">
                            <option th:each="map,userStat:${list}" th:value="${map.ACTNAME}" th:text="${map.ACTNAME}"></option>

                        </select>
                    </td>

                    <td align="left" valign="middle" bgcolor="#FFFFFF">
                        <input id="TextActName" name="TextActName" class="txt" style="width:150px"></td>
                    <td align="center" valign="middle" bgcolor="#FFFFFF">
                        <button type="button" id="btnadd" class="sendMsg btnGreen2 btn" style="width:100px">添加</button>

                    </td>
                    <td align="center" valign="middle" bgcolor="#FFFFFF">
                        <button type="button" id="btnsave" class="sendMsg btnGreen2 btn"
                            style="width:100px">保存权限</button>
                    </td>
                    <td align="center" valign="middle" bgcolor="#FFFFFF">
                        <button type="button" id="btnedit" class="sendMsg btnGreen2 btn" style="width:100px">修改名称</button>
                    </td>
                    <td align="center" valign="middle" bgcolor="#FFFFFF">
                        <button type="button" id="btndel" class="sendMsg btnGreen2 btn" style="width:100px">删除</button>
                    </td>
                </tr>
                <tr>
                    <td align="right" valign="middle" bgcolor="#FFFFFF">角色权限：</td>
                    <td align="left" valign="top" bgcolor="#FFFFFF" colspan="6">
                        <div class="s_role" id="relation" style="height: 555px;">
                            <ul id="treemenu" class="ztree"></ul>
                        </div>

                    </td>
                </tr>
            </tbody>
        </table>

        <div id="extendMenuBox" style="display: none;width:500px; height:250px;">
            <table style=" border:0; width:100%; padding:2px;" cellspacing="4" cellpadding="tab">
                <tbody>
                    <tr style=" height:22px;">
                        <th>
                            菜单选中角色
                        </th>
                        <th>
                            功能（将角色拖到对应的功能后面）
                        </th>
                    </tr>
                    <tr>
                        <td valign="top"><input type="hidden" id="choosemenuid">
                            <ul id="roleBox">
                            </ul>
                        </td>
                        <td valign="top">
                            <ul id="actionBox">
                            </ul>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <script type="text/javascript" th:inline="javascript">
        var SmallBtn = function (treeNode) {
            if ($("#diyBtn_" + treeNode.id).length > 0) {
                $.post(location.pathname + location.search, {
                    "action": "chooseMenu",
                    "id": treeNode.id,
                    "tokensign":$.cookie("tokensign")
                }, function (result) {
                    var result2 = result[1];
                    var obj = JSON.parse(result2);
                    editExtendPurview(treeNode, obj, result[0]);
                    $("#choosemenuid").val(treeNode.id);
                }, "json");
            }
        }
        var treemenu = [[${menus}]];
        var setting={
            showLine:true,
            expandSpeed:"",
            isSimpleData:true,
            checkable:true,
            checkType:{"Y":"", "N":""},
            rootPID :"0",
            treeNodeKey:"id",
            treeNodeParentKey:"pid"
        }
        var RoleTree = null; //$('#ztree').zTree($.extend(setting,{callback:{click:RoleOnClick}}), treedate);

        setting.addDiyDom = addDiyDom; //
        var MenuTree = $('#treemenu').zTree($.extend(setting,{
            checkType: {
                "Y": "ps",
                "N": "ps"
            },
            callback: {
                click: null
            }
        }), treemenu);

        $("#btnSubmit").click(function () {
            var node = RoleTree.getCheckedNodes();
            if (node.length == 0) {
                alert("请勾选角色！");
                return false;
            }
            var menunode = MenuTree.getCheckedNodes();
            if (menunode.length == 0) {
                alert("请勾选角色菜单！");
                return false;
            }
            var gid = [],
                mid = [];
            $.each(node, function (i, n) {
                gid.push(n.id);
            });
            $.each(menunode, function (i, n) {
                mid.push(n.id);
            });
            return $.submit({
                "action": "setting",
                "tokensign":$.cookie("tokensign"),
                "gid": gid.join(","),
                "mid": mid.join(",")
            }, function () {
                alert('保存成功!');
            });
        });


        //添加按钮
        function addDiyDom(treeId, treeNode) {
            if (treeNode.extendMenu) {
                var aObj = $("#" + treeNode.tId + "_a");
                if ($("#diyBtn_" + treeNode.id).length > 0) return;
                var editStr = "<input type='image' class='divBtn1' id='diyBtn_" + treeNode.id +
                    "' title='权限配置' onfocus='this.blur();' src='../images/hardware.gif' />"
                aObj.after(editStr);
                var btn = $("#diyBtn_" + treeNode.id);
                if (btn) btn.bind("click", function () {
                    SmallBtn(treeNode);
                    return false;
                });
            }
        }
        //配置菜单功能权限 
        function editExtendPurview(node, obj, role) {
            var roles = [];
            $.each(role.split(","), function (i, n) {
                var obj = new Object();
                obj.id = n;
                obj.name = n;
                roles.push(obj);
            });
            $('#roleBox').empty().append($("#extMenuRoleTmp").tmpl(roles));
            $("#actionBox").empty().append($("#extMenuTmp").tmpl(node.extendMenu));
            $.each(obj, function (i, n) { //groupid,actionobj
                console.info(n);
                if (n != "") {
                    var action = JSON.parse(n);
                    for (var p in node.extendMenu) { //listextendMenu
                        $.each(action, function (j, m) { //name,true
                            if (node.extendMenu[p].PropertyName == j) {
                                var title = $("#roleBox").find("li[key=" + i + "]").eq(0).attr("title");
                                $("#actionBox").find("li[key=" + j + "]").append(
                                    "<span title='点击删除' key=" + i + ">" + title + "</span>");
                            }
                        });
                    }
                }
            });
            $('#extendMenuBox').dialog({
                modal: true,
                title: node.name + " 菜单扩展权限配置",
                width: 600,
                height: 500,
                buttons: {
                    "提交": function () {
                        var gobj = [];
                        $("#actionBox").find("li").each(function (i) {
                            var gid = {};
                            gid.name = $(this).attr("key");
                            gid.add = [];
                            gid.del = [];
                            $(this).find("span:not([del])").each(function (i) {
                                gid.add.push($(this).attr("key"));
                            });
                            $(this).find("span[del]").each(function (i) {
                                gid.del.push($(this).attr("key"));
                            });
                            gobj.push(gid);
                        });
                        $.post(location.pathname + location.search, {
                            "action": "saveExtend",
                            "tokensign":$.cookie("tokensign"),
                            "mid": $("#choosemenuid").val(),
                            "gobj": JSON.stringify(gobj)
                        }, function (result) {}, "json");
                        $(this).dialog("close");
                    },
                    "取消": function () {
                        $(this).dialog("close");
                    }
                }
                //               , beforeClose: function () { $('#' + winId).attr("src", ""); }
            });
            $("#roleBox li").draggable({
                appendTo: "body",
                helper: "clone"
            });
            $("#actionBox .actionItem").each(function (a) {
                $(this).droppable({
                    activeClass: "ui-state-default",
                    hoverClass: "ui-state-hover",
                    drop: function (event, ui) {
                        var flag = false;
                        var _this = this;
                        $(this).find("span").each(function (i) {
                            if ($(this).text() == ui.draggable.text()) {
                                flag = true;
                            }
                        });
                        if (!flag) {
                            $("<span title='点击删除'></span>").text(ui.draggable.text()).attr("key", ui
                                .draggable.attr("key")).appendTo(_this);
                        }
                    }
                });
            });
            $(".actionItem span").live("click", function () {
                $(this).attr("del", "1").hide();
            });
        }
        $(function () {
            $(".s_role").each(function () {
                $(this).height($(window).height() - 80);
            });
            $("#act").bind("change", function () {
                $.post(location.pathname + location.search, {
                    "action": "choose",
                    "tokensign":$.cookie("tokensign"),
                    "id": $(this).val()
                }, function (result) {
                    var choosemid = result.split(",");
                    if (choosemid.length > 0) {
                        MenuTree.checkAllNodes(false);
                        var list = [];
                        $.each(choosemid, function (i, n) {
                            var node = MenuTree.getNodeByParam("id", n);
                            if (node) {
                                node.checked = true;
                                MenuTree.updateNode(node, false);
                            }
                        });
                    }
                }, "text");
            }).trigger("change");
            $("#btnadd").click(function () {
                var name = $("#TextActName").val();
                if (name == "") {
                    alert("不能添加空的角色！");
                    return;
                }
                if (name.length > 20) {
                    alert("角色名称超长，不能超过20个汉字！");
                    return;
                }
                if ($("#act").find("option[value='" + name + "']").length > 0) {
                    alert("角色已经存在！");
                    return;
                }
                $.post(location.href, {
                    "action": "add",
                    "tokensign":$.cookie("tokensign"),
                    "name": name
                }, function (data) {
                    if (data[0]) {
                        location.href = location.href;
                    }
                }, "json");
            });
            $("#btnsave").click(function () {
                var menunode = MenuTree.getCheckedNodes();
                var mid = [];
                $.each(menunode, function (i, n) {
                    mid.push(n.id);
                });
                $.post(location.href, {
                    "action": "save",
                    "tokensign":$.cookie("tokensign"),
                    "name": $("#act").val(),
                    "mid": mid.join(",")
                }, function (data) {
                    if (data[0]) {
                        alert("保存成功!");
                    }
                }, "json");
            });
            $("#btndel").click(function () {
                if ($("#act").val() == "管理员") {
                    alert("不能删除管理员！");
                    return;
                }
                $.post(location.href, {
                    "action": "remove",
                    "tokensign":$.cookie("tokensign"),
                    "name": $("#act").val()
                }, function (data) {
                    if (data[0]) {
                        location.href = location.href;
                    }
                }, "json");
            });
            $("#btnedit").click(function () {
                if ($("#act").val() == "管理员") {
                    alert("不能修改管理员！");
                    return;
                }
                if ($("#TextActName").val() == "") {
                    alert("请输入新的角色名称");
                    $("#TextActName").focus();
                    return;
                }
                $.post(location.href, {
                    "action": "edit",
                    "tokensign":$.cookie("tokensign"),
                    "name": $("#act").val(),
                    "newname": $("#TextActName").val()
                }, function (data) {
                    if (data[0]) {
                        location.href = location.href;
                    }
                }, "json");
            });
        });
    </script>
</body>

</html>