<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>
        菜单
    </title>
    <link href="../css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="../js/ztree/zTreeStyle.css" rel="stylesheet" type="text/css">
    <style type="text/css">
        .tree {
            padding: 20px 0 0 0;
        }

        #ztree {
            width: 300px;
            overflow-y: auto;
        }

        #ztree * {
            font-size: 13px;
        }

        #labid {
            font-size: 14px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="row" style="padding-top:30px;">
            <div class="col-sm-3">
                <div class="btn-group " role="group">
                    <button type="button" id="btnAddNode" class="btn btn-default">添加</button>
                    <button type="button" id="btnDel" class="btn btn-default">删除</button>
                    <button type="button" id="btnMoveUp" class="btn btn-default">上移</button>
                    <button type="button" id="btnMoveDown" class="btn btn-default">下移</button>
                </div>
                <div class="tree">
                    <ul class="ztree" id="ztree"></ul>
                </div>
            </div>
            <div class="col-sm-6" style="padding:50px 0 0 0;">
                <form class="form form-horizontal" role="form">
                    <div class="form-group">
                        <label for="firstname" class="col-sm-3 control-label">菜单编号</label>
                        <div class="col-sm-9" style="">
                            <input type="text" class="form-control" id="txtmenuno" name="txtmenuno" readonly="readonly">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="txtname" class="col-sm-3 control-label">菜单名称</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" name="txtname" id="txtname">
                            <input type="hidden" id="txtpid" name="txtpid" value="0">
                            <input type="hidden" id="txtAction" name="txtAction" value="add">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="txtcode" class="col-sm-3 control-label">图标关键字</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" name="txtmainword" id="txtmainword">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="txtcode" class="col-sm-3 control-label">菜单地址</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" name="txturl" id="txturl">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="txtName" class="col-sm-3 control-label">显示状态</label>
                        <div class="col-sm-9">
                            <label class="radio-inline">
                                <input type="radio" id="txtvalid1" name="txtvalid" value="1">显示
                            </label>
                            <label class="radio-inline">
                                <input type="radio" id="txtvalid0" name="txtvalid" value="0">隐藏
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-offset-3 col-sm-9">
                            <button type="button" id="btnSubmit" class="btn btn-primary">提交</button>
                        </div>
                    </div>
                </form>
            </div>

        </div>
    </div>

    <script src="../js/jquery-1.11.3.min.js" type="text/javascript"></script>
    <script src="../js/bootstrap.min.js" type="text/javascript"></script>

    <script src="../js/ztree/jquery.ztree-2.6.min.js" type="text/javascript"></script>
    <script type="text/javascript" th:inline="javascript">
        var IsRoot = function () {
            if ($("#txtmenuno").val() == "") {
                alert("请选择菜单节点！");
                return true;
            } else {
                return false;
            }
        }
        $("#btnAddNode").click(function () {
            var pid = $("#txtmenuno").val();
            $(".form").find("input:not([type=radio]),select").val("");
            if (pid == "") {
                pid = "0";
            }
            $("#txtpid").val(pid);
            $("#txtAction").val("add");
            $("#txtvalid1")[0].checked = true;
            //$("#spanid").html("");
            $("#txtmenuno").removeAttr("readonly");
            return false;
        });
        $("#btnDel").click(function () {
            if (confirm("删除该菜单可能会引发错误，确定删除？")) {
                if (!IsRoot()) {
                    $("#txtAction").val("delete");
                    return sumbitform(resultFunction);
                }
            }
        });
        $("#btnMoveUp").click(function () {
            if (!IsRoot()) {
                $("#txtAction").val("up");
                sumbitform(resultFunction);
                $("#txtAction").val("modify");
            }
        });
        $("#btnMoveDown").click(function () {
            if (!IsRoot()) {
                $("#txtAction").val("down");
                sumbitform(resultFunction);
                $("#txtAction").val("modify");
            }
        });
        $("#btnSubmit").click(function () {
            if ($("#txtname").val() == "") {
                alert("请输入菜单名称");
                return false;
            }
            sumbitform(resultFunction);
            return false;
        });
        var zTreeOnClick = function (event, treeID, treeNode) {
            //$("#spanid").html(treeNode.id);
            $("#txtmenuno").val(treeNode.id);
            $("#txtmenuno").attr("readonly", "readonly");
            $("#txtname").val(treeNode.name);
            $("#txtpid").val(treeNode.pid);
            $("#txtvalid" + treeNode.valid)[0].checked = true;
            $("#txtmainword").val(treeNode.mainword);
            $("#txturl").val(treeNode.urls);
            if ($("#txtdicid").val() == "") {
                $("#txtAction").val("add");
            } else {
                $("#txtAction").val("modify");
            }
        }

        function getPreTreeNode(treeNode) {
            if (treeNode.isFirstNode) return null;
            var nodes = treeNode.parentNode ? treeNode.parentNode.nodes : zTreeObj.getNodes();
            var preNode;
            for (var i = 0; i < nodes.length; i++) {
                if (nodes[i] == treeNode) {
                    return preNode;
                }
                preNode = nodes[i];
            }
        }

        function getNextTreeNode(treeNode) {
            if (treeNode.isLastNode) return null;
            var nodes = treeNode.parentNode ? treeNode.parentNode.nodes : zTreeObj.getNodes();
            for (var i = 0; i < nodes.length; i++) {
                if (nodes[i] == treeNode) {
                    return nodes[i + 1];
                }
            }
        }
        var treedate =[[${list}]];
        treedate.push({
            id: 0,
            pid: -1,
            name: "菜单",
            open: true,
            valid: 1
        });
        var setting = {
            showLine: true,
            expandSpeed: "",
            isSimpleData: true,
            rootPID: "-1",
            treeNodeKey: "id",
            treeNodeParentKey: "pid",
            callback: {
                click: zTreeOnClick
            }
        }
        var zTreeObj = $('#ztree').zTree(setting, treedate);


        var resultFunction = function (id) {
            var node = zTreeObj.getSelectedNode();
            switch ($("#txtAction").val()) {
                case "add":
                    node = {};
                    node.id = id;
                    node.pid = $("#txtpid").val();
                    node.name = $("#txtname").val();
                    node.valid = $("[name=txtvalid]:checked").val();
                    node.urls = $("#txturl").val();
                    node.mainword = $("#txtmainword").val();
                    node.open = true;
                    var parentnode = zTreeObj.getSelectedNode();
                    if (node.id != undefined && node.id != "") {
                        zTreeObj.addNodes(parentnode ? parentnode : null, node);
                    }
                    if (zTreeObj.getSelectedNode() != null) {
                        zTreeOnClick(null, "ztree", zTreeObj.getSelectedNode());
                    }
                    break;
                case "delete":
                    var delnode = node;
                    zTreeObj.removeNode(delnode);
                    break;
                case "modify":
                    node.pid = $("#txtpid").val();
                    node.name = $("#txtname").val();
                    node.valid = $("[name=txtvalid]:checked").val();
                    node.urls = $("#txturl").val();
                    node.mainword = $("#txtmainword").val();
                    zTreeObj.updateNode(node, true);
                    break;
                case "up":
                    var targetnode = node;
                    if (targetnode.isFirstNode) {
                        msg = "已经是第一个节点了！";
                    } else {
                        var parent = getPreTreeNode(targetnode);
                        if (parent != null) {
                            zTreeObj.moveNode(parent, targetnode, "before");
                        }
                    }
                    break;
                case "down":
                    var downnode = node;
                    if (downnode.isLastNode) {
                        msg = "已经是最后一个节点了！";
                    } else {
                        var downparent = getNextTreeNode(downnode);
                        if (downparent != null) {
                            zTreeObj.moveNode(downparent, downnode, "after");
                        }
                    }
                    break;
            }
        }
        var sumbitform = function (callback) {
            console.info($(".form").serialize());
            $.ajax({
                type: "POST",
                url: location.href,
                data: $(".form").serialize(),
                dataType: "json",
                async: false,
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    alert("数据保存错误。");
                },
                success: function (data) {
                    $("#btnSubmit").removeAttr("disabled");
                    msg = "保存成功";
                    if (data) {
                        callback(data);
                        //alert(msg);
                        //$("#message").html(msg).show().fadeOut(2000);
                    }
                },
                beforeSend: function () {
                    $("#btnSubmit").attr("disabled", "disabled");
                },
                complete: function () {
                    $("#btnSubmit").removeAttr("disabled");
                }
            });
            return false;
        }
    </script>


</body>

</html>